<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Sessions</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface-hover: #1c2129;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --green: #3fb950;
    --yellow: #d29922;
    --orange: #db6d28;
    --blue: #58a6ff;
    --purple: #bc8cff;
    --red: #f85149;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  /* Header */
  .header {
    padding: 1.5rem 2rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }
  .header h1 { font-size: 1.25rem; font-weight: 600; }
  .header-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-dim);
  }
  .header-stats .count { font-weight: 600; }
  .stat-active .count { color: var(--green); }
  .stat-idle .count { color: var(--yellow); }
  .stat-waiting .count { color: var(--orange); }

  /* Filters */
  .filters {
    padding: 0.75rem 2rem;
    display: flex;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border);
  }
  .filter-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-btn:hover { border-color: var(--text-dim); color: var(--text); }
  .filter-btn.active { background: rgba(88,166,255,0.15); border-color: var(--blue); color: var(--blue); }

  /* Grid */
  .sessions {
    padding: 1.5rem 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 1rem;
    padding-bottom: 4rem;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.25rem 1.5rem;
    transition: border-color 0.15s;
    cursor: pointer;
  }
  .card:hover { border-color: var(--text-dim); }
  .card.status-active { border-top: 2px solid var(--green); }
  .card.status-idle { border-top: 2px solid var(--yellow); }
  .card.status-waiting { border-top: 2px solid var(--orange); }
  .card.status-ended { border-top: 2px solid var(--border); opacity: 0.7; }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }
  .card-project { font-size: 1rem; font-weight: 600; }
  .card-status {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.8rem;
    font-weight: 500;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .dot-active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-idle { background: var(--yellow); }
  .dot-waiting { background: var(--orange); animation: pulse 2s infinite; }
  .dot-ended { background: var(--text-dim); }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  .card-activity {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
    min-height: 1.3rem;
  }
  .card-activity code {
    color: var(--blue);
    background: rgba(88,166,255,0.1);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.82em;
    font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
  }
  .card-prompt {
    font-size: 0.82rem;
    color: var(--text-dim);
    margin-bottom: 0.75rem;
    font-style: italic;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.78rem;
    color: var(--text-dim);
  }
  .card-stats { display: flex; gap: 0.75rem; }
  .card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }
  .btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 0.3rem 0.7rem;
    border-radius: 6px;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn:hover { border-color: var(--blue); color: var(--blue); }
  .btn-jump:hover { border-color: var(--green); color: var(--green); }
  .btn-dismiss:hover { border-color: var(--red); color: var(--red); }

  /* Chat modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 90%;
    max-width: 750px;
    height: 85vh;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  .modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  .modal-header h2 { font-size: 1rem; }
  .modal-header-info {
    font-size: 0.78rem;
    color: var(--text-dim);
  }
  .modal-close {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 1.4rem;
    cursor: pointer;
    padding: 0.25rem;
    line-height: 1;
  }
  .modal-close:hover { color: var(--text); }

  /* Chat messages */
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 1.5rem;
  }
  .chat-msg {
    margin-bottom: 1rem;
    max-width: 90%;
  }
  .chat-msg.user {
    margin-left: auto;
  }
  .chat-msg.assistant {
    margin-right: auto;
  }
  .chat-msg-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
    font-weight: 600;
  }
  .chat-msg.user .chat-msg-label { color: var(--blue); text-align: right; }
  .chat-msg.assistant .chat-msg-label { color: var(--purple); }
  .chat-msg-body {
    padding: 0.75rem 1rem;
    border-radius: 10px;
    font-size: 0.88rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .chat-msg.user .chat-msg-body {
    background: rgba(88,166,255,0.1);
    border: 1px solid rgba(88,166,255,0.2);
    border-top-right-radius: 2px;
  }
  .chat-msg.assistant .chat-msg-body {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top-left-radius: 2px;
  }
  .chat-msg-body h1, .chat-msg-body h2, .chat-msg-body h3 {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0.5rem 0 0.25rem;
  }
  .chat-msg-body h1 { font-size: 1.05rem; }
  .chat-msg-body pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.6rem 0.8rem;
    margin: 0.4rem 0;
    overflow-x: auto;
    font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 0.82rem;
    line-height: 1.5;
    white-space: pre;
  }
  .chat-msg-body code {
    background: rgba(88,166,255,0.1);
    color: var(--blue);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    font-size: 0.84em;
    font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
  }
  .chat-msg-body pre code {
    background: none;
    color: var(--text);
    padding: 0;
    font-size: inherit;
  }
  .chat-msg-body ul, .chat-msg-body ol {
    margin: 0.3rem 0;
    padding-left: 1.5rem;
  }
  .chat-msg-body li { margin: 0.15rem 0; }
  .chat-msg-body strong { color: var(--text); }
  .chat-msg-body .tool-tag {
    display: inline-block;
    background: rgba(188,140,255,0.15);
    color: var(--purple);
    border: 1px solid rgba(188,140,255,0.2);
    border-radius: 4px;
    padding: 0.1rem 0.5rem;
    font-size: 0.75rem;
    font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
    margin: 0.15rem 0.15rem 0.15rem 0;
  }

  /* Chat input */
  .chat-input-area {
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
    background: var(--surface);
    border-radius: 0 0 12px 12px;
  }
  .chat-input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.6rem 1rem;
    border-radius: 8px;
    font-size: 0.88rem;
    font-family: inherit;
    outline: none;
    resize: none;
    min-height: 40px;
    max-height: 120px;
  }
  .chat-input:focus { border-color: var(--blue); }
  .chat-input::placeholder { color: var(--text-dim); }
  .chat-send {
    background: var(--blue);
    color: #fff;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    align-self: flex-end;
    transition: opacity 0.15s;
  }
  .chat-send:hover { opacity: 0.85; }
  .chat-send:disabled { opacity: 0.4; cursor: default; }
  .chat-send-hint {
    align-self: center;
    font-size: 0.7rem;
    color: var(--text-dim);
    white-space: nowrap;
  }

  .chat-empty {
    text-align: center;
    color: var(--text-dim);
    padding: 3rem;
    font-size: 0.9rem;
  }

  .chat-loading {
    text-align: center;
    color: var(--text-dim);
    padding: 2rem;
  }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-dim);
  }
  .empty h2 { font-size: 1.2rem; color: var(--text); margin-bottom: 0.5rem; }
  .empty p { max-width: 400px; margin: 0 auto; font-size: 0.9rem; }
  .empty code {
    display: inline-block;
    margin-top: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-family: 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 0.85rem;
    color: var(--blue);
  }

  /* Footer */
  .footer {
    padding: 0.75rem 2rem;
    text-align: center;
    font-size: 0.75rem;
    color: var(--text-dim);
    border-top: 1px solid var(--border);
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg);
  }
</style>
</head>
<body>

<div class="header">
  <h1>Claude Sessions</h1>
  <div class="header-stats" id="stats"></div>
</div>

<div class="filters">
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="active">Active</button>
  <button class="filter-btn" data-filter="idle">Idle</button>
  <button class="filter-btn" data-filter="waiting">Waiting</button>
  <button class="filter-btn" data-filter="ended">Ended</button>
</div>

<div class="sessions" id="sessions"></div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <div>
        <h2 id="modal-title"></h2>
        <div class="modal-header-info" id="modal-info"></div>
      </div>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-loading">Loading conversation...</div>
    </div>
    <div class="chat-input-area" id="chat-input-area">
      <textarea class="chat-input" id="chat-input" placeholder="Send a message to this session..." rows="1"></textarea>
      <span class="chat-send-hint">via tmux</span>
      <button class="chat-send" id="chat-send">Send</button>
    </div>
  </div>
</div>

<div class="footer">Auto-refreshing every 3s</div>

<script>
const state = {
  sessions: [],
  filter: 'all',
  modalSessionId: null,
};

// --- API ---
async function fetchSessions() {
  try {
    const res = await fetch('/api/sessions');
    if (!res.ok) return [];
    return res.json();
  } catch { return []; }
}

async function fetchTranscript(sessionId) {
  try {
    const res = await fetch(`/api/transcript/${encodeURIComponent(sessionId)}`);
    if (!res.ok) return [];
    return res.json();
  } catch { return []; }
}

async function jumpTo(sessionId) {
  try {
    await fetch(`/api/jump/${encodeURIComponent(sessionId)}`, { method: 'POST' });
  } catch {}
}

async function dismiss(sessionId) {
  try {
    await fetch(`/api/dismiss/${encodeURIComponent(sessionId)}`, { method: 'POST' });
    refresh();
  } catch {}
}

async function sendMessage(sessionId, message) {
  try {
    const res = await fetch(`/api/send/${encodeURIComponent(sessionId)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message }),
    });
    return res.json();
  } catch { return { ok: false }; }
}

// --- Formatting ---
function timeAgo(iso) {
  if (!iso) return '';
  const secs = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
  if (secs < 0) return 'just now';
  if (secs < 60) return 'just now';
  if (secs < 3600) return `${Math.floor(secs / 60)}m ago`;
  if (secs < 86400) return `${Math.floor(secs / 3600)}h ago`;
  return `${Math.floor(secs / 86400)}d ago`;
}

function shortProject(path) {
  if (!path) return 'Unknown';
  const home = path.match(/^\/Users\/[^/]+/)?.[0] || '';
  let short = home ? '~' + path.slice(home.length) : path;
  const parts = short.split('/');
  return parts.length > 3 ? parts.slice(-2).join('/') : short;
}

function projectName(path) {
  if (!path) return 'Unknown';
  return path.split('/').filter(Boolean).pop() || path;
}

function formatActivity(s) {
  const ev = s.last_event;
  const tool = s.last_tool;
  const detail = s.last_detail || '';

  if (ev === 'Stop') return 'Waiting for input';
  if (ev === 'PermissionRequest') return 'Needs permission approval';
  if (ev === 'UserPromptSubmit') {
    if (detail) return `Prompt: "${detail.slice(0, 80)}"`;
    return 'User prompted';
  }
  if (!tool) return '';

  const labels = {
    Edit: 'Editing', Write: 'Writing', Read: 'Reading',
    Bash: 'Running', Grep: 'Searching', Glob: 'Finding',
    Task: 'Task', WebSearch: 'Searching web', WebFetch: 'Fetching',
  };
  const label = labels[tool] || tool;
  if (!detail) return label;

  let d = detail;
  if ('Edit Write Read'.includes(tool) && d.includes('/')) d = d.split('/').pop();
  if (d.length > 60) d = d.slice(0, 60) + '\u2026';

  return `${label} <code>${esc(d)}</code>`;
}

function esc(s) {
  const el = document.createElement('span');
  el.textContent = s;
  return el.innerHTML;
}

function renderMarkdown(text) {
  let html = esc(text);

  // Code blocks: ```lang\n...\n```
  html = html.replace(/```[a-z]*\n([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
  html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

  // Inline code
  html = html.replace(/`([^`\n]+)`/g, '<code>$1</code>');

  // Bold
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');

  // Headers (only at line start)
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Unordered lists
  html = html.replace(/(?:^|\n)((?:- .+\n?)+)/g, (match, items) => {
    const lis = items.trim().split('\n')
      .map(li => `<li>${li.replace(/^- /, '')}</li>`).join('');
    return `<ul>${lis}</ul>`;
  });

  // Tool tags
  html = html.replace(/\[Tool: ([^\]]+)\]/g, '<span class="tool-tag">$1</span>');

  return html;
}

// --- Rendering ---
function renderStats(sessions) {
  const counts = {};
  sessions.forEach(s => { counts[s.status] = (counts[s.status] || 0) + 1; });
  const el = document.getElementById('stats');
  let html = '';
  if (counts.active) html += `<span class="stat-active"><span class="count">${counts.active}</span> active</span>`;
  if (counts.idle) html += `<span class="stat-idle"><span class="count">${counts.idle}</span> idle</span>`;
  if (counts.waiting) html += `<span class="stat-waiting"><span class="count">${counts.waiting}</span> waiting</span>`;
  if (counts.ended) html += `<span><span class="count">${counts.ended}</span> ended</span>`;
  el.innerHTML = html || '<span>No sessions</span>';
}

function renderSessions(sessions) {
  const container = document.getElementById('sessions');
  const filtered = state.filter === 'all'
    ? sessions
    : sessions.filter(s => s.status === state.filter);

  if (filtered.length === 0) {
    container.innerHTML = `
      <div class="empty" style="grid-column: 1 / -1;">
        <h2>${state.filter === 'all' ? 'No sessions yet' : `No ${state.filter} sessions`}</h2>
        <p>${state.filter === 'all' ? 'Start a Claude Code session and it will appear here automatically.' : 'Try a different filter.'}</p>
        ${state.filter === 'all' ? '<code>claude-track setup</code>' : ''}
      </div>`;
    return;
  }

  container.innerHTML = filtered.map(s => {
    const activity = formatActivity(s);
    const hasPane = !!s.tmux_pane;
    return `
    <div class="card status-${s.status}" data-id="${esc(s.session_id)}">
      <div class="card-header">
        <div class="card-project">${esc(projectName(s.project_dir))}</div>
        <div class="card-status">
          <span class="dot dot-${s.status}"></span>
          ${s.status}
        </div>
      </div>
      <div class="card-activity">${activity}</div>
      ${s.last_prompt ? `<div class="card-prompt">"${esc(s.last_prompt.slice(0, 100))}"</div>` : ''}
      <div class="card-meta">
        <div class="card-stats">
          <span>${s.prompt_count || 0} prompts</span>
          <span>${s.tool_count || 0} tools</span>
        </div>
        <div class="card-time">${timeAgo(s.last_activity)}</div>
      </div>
      <div class="card-actions">
        ${hasPane ? `<button class="btn btn-jump" onclick="event.stopPropagation(); jumpTo('${esc(s.session_id)}')">Jump to pane</button>` : ''}
        <button class="btn" onclick="event.stopPropagation(); showChat('${esc(s.session_id)}')">Conversation</button>
        ${s.status === 'ended' ? `<button class="btn btn-dismiss" onclick="event.stopPropagation(); dismiss('${esc(s.session_id)}')">Dismiss</button>` : ''}
      </div>
    </div>`;
  }).join('');

  container.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', () => showChat(card.dataset.id));
  });
}

function renderChat(messages) {
  const container = document.getElementById('chat-messages');

  if (messages.length === 0) {
    container.innerHTML = '<div class="chat-empty">No conversation yet.</div>';
    return;
  }

  container.innerHTML = messages.map(m => {
    const role = m.role;
    const body = role === 'assistant' ? renderMarkdown(m.content) : esc(m.content);
    return `
      <div class="chat-msg ${role}">
        <div class="chat-msg-label">${role}</div>
        <div class="chat-msg-body">${body}</div>
      </div>`;
  }).join('');

  // Scroll to bottom
  container.scrollTop = container.scrollHeight;
}

async function showChat(sessionId) {
  state.modalSessionId = sessionId;
  const session = state.sessions.find(s => s.session_id === sessionId);
  if (!session) return;

  document.getElementById('modal-title').textContent = projectName(session.project_dir);
  const infoParts = [shortProject(session.project_dir)];
  if (session.model) infoParts.push(session.model);
  if (session.tmux_window) infoParts.push(`tmux: ${session.tmux_window}`);
  document.getElementById('modal-info').textContent = infoParts.join(' \u00b7 ');

  // Show/hide input based on whether we have a tmux pane
  const inputArea = document.getElementById('chat-input-area');
  inputArea.style.display = session.tmux_pane ? 'flex' : 'none';

  document.getElementById('chat-messages').innerHTML = '<div class="chat-loading">Loading conversation...</div>';
  document.getElementById('modal-overlay').classList.add('visible');

  const messages = await fetchTranscript(sessionId);
  renderChat(messages);

  // Focus input
  if (session.tmux_pane) {
    document.getElementById('chat-input').focus();
  }
}

// --- Chat input ---
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');

chatInput.addEventListener('input', () => {
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
});

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    doSend();
  }
});

chatSend.addEventListener('click', doSend);

async function doSend() {
  const msg = chatInput.value.trim();
  if (!msg || !state.modalSessionId) return;

  chatSend.disabled = true;
  chatInput.value = '';
  chatInput.style.height = 'auto';

  // Optimistically add to chat
  const container = document.getElementById('chat-messages');
  const msgEl = document.createElement('div');
  msgEl.className = 'chat-msg user';
  msgEl.innerHTML = `
    <div class="chat-msg-label">you (via tmux)</div>
    <div class="chat-msg-body">${esc(msg)}</div>`;
  container.appendChild(msgEl);
  container.scrollTop = container.scrollHeight;

  const result = await sendMessage(state.modalSessionId, msg);
  if (result && !result.ok) {
    msgEl.style.borderLeft = '3px solid #e74c3c';
    const errEl = document.createElement('div');
    errEl.style.cssText = 'color:#e74c3c;font-size:0.85em;margin-top:4px;';
    errEl.textContent = `Failed to send: ${result.error || 'Unknown error'}`;
    msgEl.querySelector('.chat-msg-body').appendChild(errEl);
  }
  chatSend.disabled = false;
  chatInput.focus();

  // Refresh transcript after a delay to pick up the response
  setTimeout(async () => {
    const messages = await fetchTranscript(state.modalSessionId);
    renderChat(messages);
  }, 3000);
}

// Auto-refresh transcript if modal is open
setInterval(async () => {
  if (state.modalSessionId && document.getElementById('modal-overlay').classList.contains('visible')) {
    const messages = await fetchTranscript(state.modalSessionId);
    renderChat(messages);
  }
}, 5000);

// --- Event handlers ---
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.filter = btn.dataset.filter;
    renderSessions(state.sessions);
  });
});

document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('visible');
    state.modalSessionId = null;
  }
});
document.getElementById('modal-close').addEventListener('click', () => {
  document.getElementById('modal-overlay').classList.remove('visible');
  state.modalSessionId = null;
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('modal-overlay').classList.remove('visible');
    state.modalSessionId = null;
  }
});

// --- Refresh loop ---
async function refresh() {
  state.sessions = await fetchSessions();
  renderStats(state.sessions);
  renderSessions(state.sessions);
}

refresh();
setInterval(refresh, 3000);
</script>
</body>
</html>
